//TODO move out initialization of Handler


        ImageProcessing imageProcessing = new ImageProcessing();

        logger.info("Starting request handler");
        logger.info("Event: " + gson.toJson(s3event));


        Region region = Region.US_WEST_2;
        s3 = S3Client.builder()
                .region(region)
                .build();

        createBucket(s3, bucketName, region);

        PutObjectRequest objectRequest = PutObjectRequest.builder()
                .bucket(bucketName)
                .key(key)
                .build();

        s3.putObject(objectRequest, RequestBody.fromByteBuffer(getRandomByteBuffer(10_000)));


        S3EventNotificationRecord record = s3event.getRecords().get(0);
        String srcBucket = record.getS3().getBucket().getName();
        // Object key may have spaces or unicode non-ASCII characters.
        String srcKey = record.getS3().getObject().getUrlDecodedKey();
        String imageType = imageUtils.determineImageType(srcKey);
        if (imageType.equals("")){
            return "";
        }

        logger.info("Src bucket: " + srcBucket + " key:" + srcKey + " Img type: " + imageType);



        //get object
        AmazonS3 s3Client = AmazonS3ClientBuilder.defaultClient();
        ObjectMetadata objectMetadata = s3Client.getObjectMetadata(new GetObjectMetadataRequest(srcBucket, srcKey));
        System.out.println(objectMetadata);
        Map<String, Object> rawMetadata = objectMetadata.getRawMetadata();
        logger.info("metadata= " + rawMetadata);


        S3Object s3Object = s3Client.getObject(new GetObjectRequest(
                srcBucket, srcKey));
        InputStream objectData = s3Object.getObjectContent();


        try {
            BufferedImage srcImage = ImageIO.read(objectData);
            try {
                String dstBucket = PROCESSED_IMAGES_BUCKET;
                String dstKey = "resized-" + srcKey;


                int srcHeight = srcImage.getHeight();
                int srcWidth = srcImage.getWidth();
                // Infer the scaling factor to avoid stretching the image
                // unnaturally
                float scalingFactor = Math.min(MAX_WIDTH / srcWidth, MAX_HEIGHT
                        / srcHeight);
                int width = (int) (scalingFactor * srcWidth);
                int height = (int) (scalingFactor * srcHeight);

                BufferedImage resizedImage = new BufferedImage(width, height,
                        BufferedImage.TYPE_INT_RGB);
                Graphics2D g = resizedImage.createGraphics();
                // Fill with white before applying semi-transparent (alpha) images
                g.setPaint(Color.white);
                g.fillRect(0, 0, width, height);
                // Simple bilinear resize
                g.setRenderingHint(RenderingHints.KEY_INTERPOLATION,
                        RenderingHints.VALUE_INTERPOLATION_BILINEAR);
                g.drawImage(srcImage, 0, 0, width, height, null);
                g.dispose();

                // Re-encode image to target format
                ByteArrayOutputStream os = new ByteArrayOutputStream();
                ImageIO.write(resizedImage, imageType, os);
                InputStream is = new ByteArrayInputStream(os.toByteArray());
                // Set Content-Length and Content-Type
                ObjectMetadata meta = new ObjectMetadata();
                meta.setContentLength(os.size());

                meta.setContentType(imageUtils.getMimeType(imageType));
                s3Client.putObject(dstBucket, dstKey, is, s3Object.getObjectMetadata());
            } catch (AmazonServiceException e) {
                logger.info("Write failed");
                logger.error(e.getErrorMessage());
                System.exit(1);
            }
        } catch (IOException e) {
            logger.info("Error reading image");
            e.printStackTrace();
        }


        return "Okss";

        /*
        try {
            logger.info("hii");
            logger.info("EVENT: " + gson.toJson(s3event));



            S3EventNotificationRecord record = s3event.getRecords().get(0);
            String srcBucket = record.getS3().getBucket().getName();

            // Object key may have spaces or unicode non-ASCII characters.
            String srcKey = record.getS3().getObject().getUrlDecodedKey();


            String dstBucket = "image-processing-app-destination";
            String dstKey = "resized-" + srcKey;


            // Infer the image type.
         *//*   Matcher matcher = Pattern.compile(".*\\.([^\\.]*)").matcher(srcKey);
            if (!matcher.matches()) {
                logger.info("Unable to infer image type for key " + srcKey);
                return "";
            }
            String imageType = matcher.group(1);
            if (!(JPG_TYPE.equals(imageType)) && !(PNG_TYPE.equals(imageType))) {
                logger.info("Skipping non-image " + srcKey);
                return "";
            }*//*

            // Download the image from S3 into a stream
            AmazonS3 s3Client = AmazonS3ClientBuilder.defaultClient();
            S3Object s3Object = s3Client.getObject(new GetObjectRequest(
                    srcBucket, srcKey));
            InputStream objectData = s3Object.getObjectContent();

            // Read the source image
          *//*  BufferedImage srcImage = ImageIO.read(objectData);
            int srcHeight = srcImage.getHeight();
            int srcWidth = srcImage.getWidth();
            // Infer the scaling factor to avoid stretching the image
            // unnaturally
            float scalingFactor = Math.min(MAX_WIDTH / srcWidth, MAX_HEIGHT
                    / srcHeight);
            int width = (int) (scalingFactor * srcWidth);
            int height = (int) (scalingFactor * srcHeight);

            BufferedImage resizedImage = new BufferedImage(width, height,
                    BufferedImage.TYPE_INT_RGB);
            Graphics2D g = resizedImage.createGraphics();
            // Fill with white before applying semi-transparent (alpha) images
            g.setPaint(Color.white);
            g.fillRect(0, 0, width, height);
            // Simple bilinear resize
            g.setRenderingHint(RenderingHints.KEY_INTERPOLATION,
                    RenderingHints.VALUE_INTERPOLATION_BILINEAR);
            g.drawImage(srcImage, 0, 0, width, height, null);
            g.dispose();

            // Re-encode image to target format
            ByteArrayOutputStream os = new ByteArrayOutputStream();
            ImageIO.write(resizedImage, imageType, os);
            InputStream is = new ByteArrayInputStream(os.toByteArray());
            // Set Content-Length and Content-Type
            ObjectMetadata meta = new ObjectMetadata();
            meta.setContentLength(os.size());
            if (JPG_TYPE.equals(imageType)) {
                meta.setContentType(JPG_MIME);
            }
            if (PNG_TYPE.equals(imageType)) {
                meta.setContentType(PNG_MIME);
            }
*//*
            // Uploading to S3 destination bucket
            logger.info("Writing to: " + dstBucket + "/" + dstKey);
            try {
                s3Client.putObject(dstBucket, dstKey, objectData, new ObjectMetadata());
            }
            catch(AmazonServiceException e)
            {
                logger.info("Write failed");
                logger.error(e.getErrorMessage());
                System.exit(1);
            }
            logger.info("Successfully resized " + srcBucket + "/"
                    + srcKey + " and uploaded to " + dstBucket + "/" + dstKey);
            return "Ok";
        } catch (Exception e) {
            throw new RuntimeException(e);
        }*/
